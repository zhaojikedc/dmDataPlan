# 数据源替换实施说明

## 替换概述

已成功将 `o_line_management.html` 中的数据源从 `o_line_table_info.json` 替换为 `table_metadata.json`，以解决数据不完整的问题。

## 修改内容

### 1. 主要修改
- **文件**: `html/o_line_management.html`
- **函数**: `loadTableMetadata()`
- **修改**: 将主要数据源从 `o_line_table_info.json` 改为 `table_metadata.json`

### 2. 具体变更

#### 修改前
```javascript
// 首先尝试从o_line_table_info.json加载
const tableInfo = await api.getData('o_line_table_info.json');
```

#### 修改后
```javascript
// 首先尝试从table_metadata.json加载（完整数据源）
const tableInfo = await api.getData('table_metadata.json');
```

### 3. 数据加载优先级调整

#### 新的优先级顺序
1. **第一优先级**: `table_metadata.json` (通过API) - 6个表，完整数据
2. **第二优先级**: `table_metadata.json` (直接文件加载) - 6个表，完整数据
3. **第三优先级**: `o_line_table_info.json` (备用数据源) - 3个表，不完整数据

#### 优势
- 优先使用完整数据源
- 保持向后兼容性
- 降低数据不完整的风险

## 数据完整性对比

### table_metadata.json (新的主要数据源)
- **表数量**: 6个表 ✅
- **文件大小**: 1496行 ✅
- **数据状态**: 完整 ✅
- **包含的表**:
  1. `dim.dim_tp_air_full_cargo_di` (航空全货机维度表)
  2. `dm_pass_atp.tm_air_flow_config_wide` (流向配置宽表)
  3. `dm_tp.dm_tp_air_flow_weight_sum_di` (流向重量汇总事实表)
  4. `dm_tp.dm_tp_air_full_flow_sum_di` (全流向汇总事实表)
  5. `dm_tp.dm_tp_air_full_time_achieve_sum_di` (时效达成汇总事实表)
  6. `dm_tp.dm_tp_air_get_price_dtl_di` (价格明细事实表)

### o_line_table_info.json (备用数据源)
- **表数量**: 3个表 ⚠️
- **文件大小**: 125行 ⚠️
- **数据状态**: 不完整 ⚠️

## 预期效果

### 1. 用户体验改善
- 数据库下拉列表将显示所有6个数据库
- 表选择功能将显示所有6个表
- 数据关系创建功能将更加完整

### 2. 功能完整性
- 表关系创建不再受限
- 已选表信息更加完整
- 数据同步功能更加稳定

### 3. 向后兼容性
- 如果 `table_metadata.json` 加载失败，仍会尝试 `o_line_table_info.json`
- 现有功能不会受到影响
- API端点保持不变

## 验证方法

### 1. 浏览器控制台检查
打开浏览器开发者工具，查看控制台日志：
```
开始加载表元数据...
尝试从table_metadata.json加载...
从table_metadata.json加载表元数据成功: {...}
```

### 2. 功能测试
1. 刷新页面
2. 检查数据库下拉列表是否显示所有数据库
3. 选择数据库，检查表列表是否显示所有表
4. 测试表选择功能
5. 测试表关系创建功能

### 3. 数据验证
- 确认可以看到6个表而不是3个表
- 确认所有表信息都正确显示
- 确认表关系功能正常工作

## 风险控制

### 1. 备份策略
- 保留 `o_line_table_info.json` 作为备用数据源
- 如果新数据源出现问题，可以快速回滚

### 2. 监控要点
- 关注控制台日志中的错误信息
- 监控数据加载是否成功
- 检查功能是否正常工作

### 3. 回滚方案
如果出现问题，可以快速回滚：
1. 将 `loadTableMetadata()` 函数中的 `table_metadata.json` 改回 `o_line_table_info.json`
2. 调整优先级顺序
3. 重新测试功能

## 总结

✅ **替换成功**: 已成功将主要数据源替换为 `table_metadata.json`
✅ **数据完整**: 现在可以访问所有6个表
✅ **向后兼容**: 保留了备用数据源机制
✅ **风险可控**: 有完整的回滚方案

现在页面应该能够显示完整的表信息，用户可以选择所有6个表进行关系创建。
