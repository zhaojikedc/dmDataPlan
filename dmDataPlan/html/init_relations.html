<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>关系数据初始化页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        .relation-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #1890ff;
        }
        .relation-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .relation-item p {
            margin: 2px 0;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>O线ER关系数据初始化页面</h1>
        <p>此页面用于初始化O线ER关系图的关系数据，基于表元数据中的表结构创建合理的关联关系。</p>
        
        <div class="section">
            <h3>1. 查看当前关系数据</h3>
            <button onclick="loadCurrentRelations()">加载当前关系数据</button>
            <div id="currentRelations" class="result">点击按钮查看当前关系数据</div>
        </div>
        
        <div class="section">
            <h3>2. 初始化示例关系数据</h3>
            <button onclick="initSampleRelations()">初始化示例关系</button>
            <div id="initResult" class="result">点击按钮初始化示例关系数据</div>
        </div>
        
        <div class="section">
            <h3>3. 同步到关系创建页面</h3>
            <button onclick="syncToRelationPage()">同步到关系创建页面</button>
            <div id="syncResult" class="result">点击按钮将关系数据同步到关系创建页面</div>
        </div>
        
        <div class="section">
            <h3>4. 验证数据完整性</h3>
            <button onclick="validateData()">验证数据完整性</button>
            <div id="validateResult" class="result">点击按钮验证数据完整性</div>
        </div>
    </div>

    <script>
        let currentRelations = [];
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }
        
        async function loadCurrentRelations() {
            try {
                showResult('currentRelations', '正在加载当前关系数据...', 'info');
                
                const response = await fetch('../config/o_line_er_models.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                currentRelations = data.erModels || [];
                
                if (currentRelations.length === 0) {
                    showResult('currentRelations', '当前没有关系数据', 'info');
                } else {
                    let result = `当前关系数据 (${currentRelations.length} 条):\n\n`;
                    currentRelations.forEach((rel, index) => {
                        result += `${index + 1}. ${rel.name}\n`;
                        result += `   源表: ${rel.sourceTable}\n`;
                        result += `   目标表: ${rel.targetTable}\n`;
                        result += `   关系: ${rel.sourceField} -> ${rel.targetField}\n`;
                        result += `   类型: ${rel.relationType}\n`;
                        result += `   描述: ${rel.relationDesc}\n\n`;
                    });
                    showResult('currentRelations', result, 'success');
                }
                
            } catch (error) {
                showResult('currentRelations', `加载关系数据失败: ${error.message}`, 'error');
            }
        }
        
        async function initSampleRelations() {
            try {
                showResult('initResult', '正在初始化示例关系数据...', 'info');
                
                // 检查是否已有数据
                if (currentRelations.length > 0) {
                    showResult('initResult', '关系数据已存在，无需重复初始化', 'info');
                    return;
                }
                
                // 初始化示例关系数据
                const sampleRelations = [
                    {
                        "id": "rel_001",
                        "name": "航空全货机维度表与流向配置关系",
                        "description": "航空全货机维度表与流向配置宽表之间的关联关系",
                        "sourceTable": "dim.dim_tp_air_full_cargo_di",
                        "targetTable": "dm_pass_atp.tm_air_flow_config_wide",
                        "sourceField": "deprt_city_code",
                        "targetField": "src_city_code",
                        "relationType": "1:N",
                        "relationDesc": "一个始发城市代码可以对应多个流向配置",
                        "createdBy": "system",
                        "createdTime": new Date().toISOString()
                    },
                    {
                        "id": "rel_002", 
                        "name": "航空全货机维度表与流向配置关系2",
                        "description": "航空全货机维度表与流向配置宽表之间的关联关系",
                        "sourceTable": "dim.dim_tp_air_full_cargo_di",
                        "targetTable": "dm_pass_atp.tm_air_flow_config_wide",
                        "sourceField": "arrive_city_code",
                        "targetField": "dest_city_code",
                        "relationType": "1:N",
                        "relationDesc": "一个目的地城市代码可以对应多个流向配置",
                        "createdBy": "system",
                        "createdTime": new Date().toISOString()
                    },
                    {
                        "id": "rel_003",
                        "name": "流向配置与流向重量汇总关系",
                        "description": "流向配置宽表与流向重量汇总事实表之间的关联关系",
                        "sourceTable": "dm_pass_atp.tm_air_flow_config_wide",
                        "targetTable": "dm_tp.dm_tp_air_flow_weight_sum_di",
                        "sourceField": "city_flow",
                        "targetField": "flight_flow",
                        "relationType": "1:N",
                        "relationDesc": "一个城市流向可以对应多个航班流向记录",
                        "createdBy": "system",
                        "createdTime": new Date().toISOString()
                    },
                    {
                        "id": "rel_004",
                        "name": "流向重量汇总与全流向汇总关系",
                        "description": "流向重量汇总事实表与全流向汇总事实表之间的关联关系",
                        "sourceTable": "dm_tp.dm_tp_air_flow_weight_sum_di",
                        "targetTable": "dm_tp.dm_tp_air_full_flow_sum_di",
                        "sourceField": "flight_task_id",
                        "targetField": "send_flight_task_id",
                        "relationType": "1:1",
                        "relationDesc": "一个飞行任务ID对应一个发送航班任务ID",
                        "createdBy": "system",
                        "createdTime": new Date().toISOString()
                    },
                    {
                        "id": "rel_005",
                        "name": "全流向汇总与时效达成汇总关系",
                        "description": "全流向汇总事实表与时效达成汇总事实表之间的关联关系",
                        "sourceTable": "dm_tp.dm_tp_air_full_flow_sum_di",
                        "targetTable": "dm_tp.dm_tp_air_full_time_achieve_sum_di",
                        "sourceField": "flight_flow",
                        "targetField": "flight_flow",
                        "relationType": "1:N",
                        "relationDesc": "一个航班流向可以对应多个时效达成记录",
                        "createdBy": "system",
                        "createdTime": new Date().toISOString()
                    }
                ];
                
                // 保存到localStorage
                localStorage.setItem('erRelations', JSON.stringify(sampleRelations));
                
                showResult('initResult', `✅ 示例关系数据初始化成功！\n\n已创建 ${sampleRelations.length} 条关系数据:\n\n${sampleRelations.map((rel, index) => 
                    `${index + 1}. ${rel.name}\n   源表: ${rel.sourceTable}\n   目标表: ${rel.targetTable}\n   关系: ${rel.sourceField} -> ${rel.targetField}\n   类型: ${rel.relationType}`
                ).join('\n\n')}`, 'success');
                
            } catch (error) {
                showResult('initResult', `初始化示例关系数据失败: ${error.message}`, 'error');
            }
        }
        
        async function syncToRelationPage() {
            try {
                showResult('syncResult', '正在同步到关系创建页面...', 'info');
                
                // 从localStorage获取关系数据
                const relationsData = localStorage.getItem('erRelations');
                if (!relationsData) {
                    showResult('syncResult', '没有找到关系数据，请先初始化示例关系数据', 'error');
                    return;
                }
                
                const relations = JSON.parse(relationsData);
                
                // 同步到关系创建页面的localStorage
                localStorage.setItem('erRelations', JSON.stringify(relations));
                
                showResult('syncResult', `✅ 关系数据同步成功！\n\n已同步 ${relations.length} 条关系数据到关系创建页面。\n\n现在可以打开关系创建页面查看同步的关系数据。`, 'success');
                
            } catch (error) {
                showResult('syncResult', `同步关系数据失败: ${error.message}`, 'error');
            }
        }
        
        async function validateData() {
            try {
                showResult('validateResult', '正在验证数据完整性...', 'info');
                
                // 检查表元数据
                const tableResponse = await fetch('../config/table_metadata.json');
                if (!tableResponse.ok) {
                    throw new Error(`表元数据加载失败: ${tableResponse.status}`);
                }
                const tableData = await tableResponse.json();
                
                // 检查关系数据
                const relationsData = localStorage.getItem('erRelations');
                if (!relationsData) {
                    showResult('validateResult', '没有找到关系数据', 'error');
                    return;
                }
                
                const relations = JSON.parse(relationsData);
                
                // 验证关系数据的完整性
                let validationResults = [];
                let validCount = 0;
                
                relations.forEach((rel, index) => {
                    const sourceTable = tableData.tables.find(t => t.name === rel.sourceTable);
                    const targetTable = tableData.tables.find(t => t.name === rel.targetTable);
                    
                    if (!sourceTable) {
                        validationResults.push(`❌ 关系 ${index + 1}: 源表 "${rel.sourceTable}" 不存在`);
                    } else if (!targetTable) {
                        validationResults.push(`❌ 关系 ${index + 1}: 目标表 "${rel.targetTable}" 不存在`);
                    } else {
                        const sourceField = sourceTable.fields.find(f => f.key === rel.sourceField);
                        const targetField = targetTable.fields.find(f => f.key === rel.targetField);
                        
                        if (!sourceField) {
                            validationResults.push(`❌ 关系 ${index + 1}: 源字段 "${rel.sourceField}" 在表 "${rel.sourceTable}" 中不存在`);
                        } else if (!targetField) {
                            validationResults.push(`❌ 关系 ${index + 1}: 目标字段 "${rel.targetField}" 在表 "${rel.targetTable}" 中不存在`);
                        } else {
                            validationResults.push(`✅ 关系 ${index + 1}: ${rel.name} - 验证通过`);
                            validCount++;
                        }
                    }
                });
                
                const result = `数据完整性验证结果:\n\n${validationResults.join('\n')}\n\n总计: ${relations.length} 条关系\n有效: ${validCount} 条\n无效: ${relations.length - validCount} 条`;
                
                showResult('validateResult', result, validCount === relations.length ? 'success' : 'error');
                
            } catch (error) {
                showResult('validateResult', `验证数据完整性失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时自动加载当前关系数据
        window.addEventListener('load', () => {
            loadCurrentRelations();
        });
    </script>
</body>
</html>
