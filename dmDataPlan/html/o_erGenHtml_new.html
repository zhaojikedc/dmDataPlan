<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oçº¿ERå…³ç³»è¯´æ˜ - æ•°æ®ä»“åº“æ•°æ®æ¨¡å‹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.css">
    <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
        }
        
        .app-header {
            background: #001529;
            color: white;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .back-btn {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .app-content {
            margin: 24px;
        }
        
        .page-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .page-header {
            background: #fafafa;
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #262626;
            margin: 0 0 8px 0;
        }
        
        .page-description {
            color: #8c8c8c;
            margin: 0;
        }
        
        .main-content {
            display: flex;
            min-height: 600px;
        }
        
        .left-panel {
            width: 300px;
            border-right: 1px solid #f0f0f0;
            background: #fafafa;
            padding: 24px;
        }
        
        .right-panel {
            flex: 1;
            padding: 24px;
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }
        
        .panel-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #1890ff;
            margin-right: 8px;
        }
        
        .data-load-section {
            margin-bottom: 24px;
        }
        
        .load-button {
            width: 100%;
            padding: 12px 16px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-bottom: 12px;
        }
        
        .load-button:hover {
            background: #40a9ff;
        }
        
        .load-button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        .data-info {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .data-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .data-info-item:last-child {
            margin-bottom: 0;
        }
        
        .data-info-label {
            font-weight: 500;
            color: #262626;
        }
        
        .data-info-value {
            color: #1890ff;
            font-weight: 500;
        }
        
        .status-message {
            padding: 8px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .status-success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .status-error {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        
        .status-info {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
        
        .canvas-area {
            position: relative;
            width: 100%;
            height: 600px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            background: #fafafa;
            overflow: auto;
        }
        
        .canvas-content {
            position: relative;
            min-width: 100%;
            min-height: 100%;
            width: max-content;
            height: max-content;
        }
        
        .toolbar {
            position: absolute;
            top: 16px;
            right: 16px;
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .toolbar-item {
            font-size: 12px;
            color: #595959;
        }
        
        .toolbar-value {
            color: #1890ff;
            font-weight: 500;
        }
        
        #tables-container {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;
            min-width: 5000px;
            min-height: 4000px;
        }
        
        #tables-container > div {
            pointer-events: auto;
        }
        
        #svg-container {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 3;
            pointer-events: none;
            min-width: 5000px;
            min-height: 4000px;
        }
        
        .er-wrapper {
            position: absolute;
            border: 2px solid #95a5a6;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            overflow: visible;
            transition: box-shadow 0.3s;
            cursor: move;
        }
        
        .er-wrapper:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        
        .er-wrapper.fact-table {
            border: 3px solid #e74c3c;
            background: #fff5f5;
        }
        
        .er-wrapper.dim-table {
            border: 3px solid #3498db;
            background: #f0f8ff;
        }
        
        .er-table {
            border-collapse: collapse;
            font-size: 12px;
            width: 100%;
        }
        
        .er-table th {
            background: #95a5a6;
            color: white;
            padding: 8px 10px;
            user-select: none;
            text-align: left;
            font-weight: 500;
            position: relative;
            cursor: pointer;
        }
        
        .fact-table .er-table th {
            background: #e74c3c;
        }
        
        .dim-table .er-table th {
            background: #3498db;
        }
        
        .er-table td {
            border-top: 1px solid #e0e0e0;
            padding: 4px 8px;
            white-space: nowrap;
        }
        
        .pk {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .fk {
            color: #2980b9;
            font-weight: 600;
        }
        
        .pk-fk {
            color: #9b59b6;
            font-weight: 600;
        }
        
        .table-type-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #52c41a;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .table-type-badge.dim-badge {
            background: #1890ff;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8c8c8c;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .empty-state-desc {
            font-size: 14px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="app-title">æ•°æ®ä»“åº“æ•°æ®æ¨¡å‹ç®¡ç†ç³»ç»Ÿ</div>
        <a href="dm_planning.html" class="back-btn">è¿”å›é¦–é¡µ</a>
    </div>

    <div class="app-content">
        <div class="page-container">
            <div class="page-header">
                <h1 class="page-title">Oçº¿ERå…³ç³»è¯´æ˜</h1>
                <p class="page-description">åŠ è½½æ¨¡å‹å…³ç³»åˆ›å»ºé¡µé¢çš„æ•°æ®ï¼Œç”ŸæˆERå…³ç³»å›¾</p>
            </div>

            <div class="main-content">
                <!-- å·¦ä¾§é¢æ¿ï¼šæ•°æ®åŠ è½½æ§åˆ¶ -->
                <div class="left-panel">
                    <div class="panel-title">æ•°æ®åŠ è½½</div>
                    
                    <!-- çŠ¶æ€æ¶ˆæ¯ -->
                    <div id="statusMessage" class="status-message" style="display: none;"></div>
                    
                    <!-- æ•°æ®è½½å…¥æŒ‰é’® -->
                    <div class="data-load-section">
                        <button class="load-button" onclick="loadERData()" id="loadButton">
                            æ•°æ®è½½å…¥
                        </button>
                        <button class="load-button" onclick="refreshERData()" id="refreshButton" style="background: #52c41a;">
                            åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                    
                    <!-- æ•°æ®ä¿¡æ¯ -->
                    <div class="data-info" id="dataInfo" style="display: none;">
                        <div class="data-info-item">
                            <span class="data-info-label">æ ‡é¢˜:</span>
                            <span class="data-info-value" id="dataTitle">-</span>
                        </div>
                        <div class="data-info-item">
                            <span class="data-info-label">è¡¨æ ¼æ•°é‡:</span>
                            <span class="data-info-value" id="dataTableCount">0</span>
                        </div>
                        <div class="data-info-item">
                            <span class="data-info-label">å…³ç³»æ•°é‡:</span>
                            <span class="data-info-value" id="dataRelationCount">0</span>
                        </div>
                        <div class="data-info-item">
                            <span class="data-info-label">æœ€åæ›´æ–°:</span>
                            <span class="data-info-value" id="dataLastUpdate">-</span>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œè¯´æ˜ -->
                    <div class="data-info">
                        <div style="font-weight: 500; margin-bottom: 8px; color: #262626;">æ“ä½œè¯´æ˜:</div>
                        <div style="font-size: 12px; color: #595959; line-height: 1.5;">
                            1. ç‚¹å‡»"æ•°æ®è½½å…¥"è‡ªåŠ¨åˆå¹¶selected_tables.jsonå’Œo_line_relations.json<br>
                            2. ç³»ç»Ÿä¼šç”Ÿæˆå®Œæ•´çš„ERå…³ç³»å›¾æ•°æ®<br>
                            3. ç›´æ¥å‘ˆç°ERå…³ç³»å›¾å†…å®¹<br>
                            4. æ”¯æŒæ‹–æ‹½ã€ç¼©æ”¾ç­‰äº¤äº’æ“ä½œ
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§é¢æ¿ï¼šERå…³ç³»å›¾ -->
                <div class="right-panel">
                    <div class="canvas-area">
                        <!-- å·¥å…·æ  -->
                        <div class="toolbar">
                            <div class="toolbar-item">
                                ç¼©æ”¾: <span class="toolbar-value" id="zoomLevel">100%</span>
                            </div>
                            <div class="toolbar-item">
                                çº¿æ¡ç±»å‹: <span class="toolbar-value" id="lineType">æ›²çº¿</span>
                            </div>
                        </div>
                        
                        <!-- ç”»å¸ƒå†…å®¹ -->
                        <div class="canvas-content">
                            <svg id="svg-container"></svg>
                            <div id="tables-container"></div>
                        </div>
                        
                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        
                        <!-- ç©ºçŠ¶æ€ -->
                        <div class="empty-state" id="emptyState">
                            <div class="empty-state-icon">ğŸ“Š</div>
                            <div class="empty-state-text">æš‚æ— ERå…³ç³»å›¾æ•°æ®</div>
                            <div class="empty-state-desc">è¯·å…ˆåŠ è½½ERæ•°æ®</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let erData = null;
        let tables = {};
        let relations = [];
        let tableRects = {};
        let wrappers = {};
        let zoomLevel = 1;
        let lineType = 'curve';

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
        });

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initializeCanvas() {
            const canvasContent = document.querySelector('.canvas-content');
            const svgContainer = document.getElementById('svg-container');
            const tablesContainer = document.getElementById('tables-container');
            
            // è®¾ç½®å®¹å™¨æ ·å¼
            svgContainer.style.position = 'absolute';
            svgContainer.style.top = '0';
            svgContainer.style.left = '0';
            svgContainer.style.zIndex = '3';
            svgContainer.style.pointerEvents = 'none';
            svgContainer.style.minWidth = '5000px';
            svgContainer.style.minHeight = '4000px';
            
            tablesContainer.style.position = 'absolute';
            tablesContainer.style.top = '0';
            tablesContainer.style.left = '0';
            tablesContainer.style.zIndex = '2';
            tablesContainer.style.pointerEvents = 'none';
            tablesContainer.style.minWidth = '5000px';
            tablesContainer.style.minHeight = '4000px';
        }


        async function loadERData() {
            showLoading(true);
            showStatusMessage('æ­£åœ¨è½½å…¥ERæ•°æ®...', 'info');
            
            try {
                // è°ƒç”¨åˆå¹¶æ•°æ®APIï¼Œç›´æ¥è·å–å®Œæ•´çš„ERæ•°æ®
                const mergeResponse = await fetch('/api/merge-er-data');
                
                if (!mergeResponse.ok) {
                    throw new Error(`æ•°æ®è½½å…¥å¤±è´¥: ${mergeResponse.status}`);
                }
                
                const mergeResult = await mergeResponse.json();
                
                if (!mergeResult.success) {
                    throw new Error(mergeResult.message || 'æ•°æ®è½½å…¥å¤±è´¥');
                }
                
                const mergedData = mergeResult.data;
                console.log('è½½å…¥çš„ERæ•°æ®:', mergedData);
                
                // ç›´æ¥ä½¿ç”¨åˆå¹¶åçš„æ•°æ®
                erData = mergedData;
                
                // æ¸²æŸ“ERå›¾
                renderERDiagram();
                updateDataInfo();
                
                // æ˜¾ç¤ºè½½å…¥ä¿¡æ¯
                showStatusMessage(`æ•°æ®è½½å…¥æˆåŠŸï¼è¡¨æ•°é‡: ${mergedData.tables.length}, å…³ç³»æ•°é‡: ${mergedData.relations.length}`, 'success');
                
            } catch (error) {
                console.error('è½½å…¥ERæ•°æ®å¤±è´¥:', error);
                showStatusMessage(`è½½å…¥å¤±è´¥: ${error.message}`, 'error');
                
                // å¦‚æœè½½å…¥å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°æ–‡ä»¶åŠ è½½
                await loadFromLocalFiles();
            } finally {
                showLoading(false);
            }
        }

        // ä»æœ¬åœ°æ–‡ä»¶åŠ è½½
        async function loadFromLocalFiles() {
            try {
                // å°è¯•åŠ è½½ç¤ºä¾‹æ•°æ®
                const response = await fetch('../config/o_line_er_models.json');
                if (response.ok) {
                    erData = await response.json();
                    renderERDiagram();
                    updateDataInfo();
                    showStatusMessage('ä»æœ¬åœ°æ–‡ä»¶åŠ è½½ERæ•°æ®æˆåŠŸ', 'success');
                } else {
                    showStatusMessage('æ²¡æœ‰æ‰¾åˆ°ERæ•°æ®æ–‡ä»¶', 'error');
                }
            } catch (error) {
                showStatusMessage('ä»æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå¹¶ERæ•°æ®
        function mergeERData(tableInfoData, relationData) {
            const mergedData = {
                title: "Oçº¿ERå…³ç³»å›¾",
                description: "æœ¬å›¾å±•ç¤ºäº†ç³»ç»Ÿæ•°æ®åº“çš„å®ä½“å…³ç³»æ¨¡å‹ï¼ŒåŒ…æ‹¬äº‹å®è¡¨å’Œç»´åº¦è¡¨åŠå…¶å…³è”å…³ç³»ã€‚",
                tables: [],
                relations: [],
                textBoxes: [],
                collapseStates: {}
            };
            
            // åˆå¹¶è¡¨ä¿¡æ¯
            if (tableInfoData && tableInfoData.tables) {
                mergedData.tables = tableInfoData.tables;
                mergedData.title = tableInfoData.title || mergedData.title;
                mergedData.description = tableInfoData.description || mergedData.description;
            }
            
            // åˆå¹¶å…³ç³»æ•°æ®
            if (relationData && relationData.relations) {
                mergedData.relations = relationData.relations;
            }
            
            return mergedData;
        }

        // æ¸²æŸ“ERå…³ç³»å›¾
        function renderERDiagram() {
            if (!erData) {
                showEmptyState(true);
                return;
            }
            
            showEmptyState(false);
            
            // æ¸…ç©ºç”»å¸ƒ
            clearCanvas();
            
            // å¤„ç†è¡¨æ ¼æ•°æ®
            tables = {};
            erData.tables.forEach(table => {
                tables[table.name] = table.fields || [];
            });
            
            // å¤„ç†å…³ç³»æ•°æ®
            relations = erData.relations || [];
            
            // åˆ›å»ºè¡¨æ ¼èŠ‚ç‚¹
            createTableNodes();
            
            // åˆ›å»ºå…³ç³»è¿çº¿
            createRelationLines();
            
            // æ›´æ–°å·¥å…·æ ä¿¡æ¯
            updateToolbar();
        }

        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            const svgContainer = document.getElementById('svg-container');
            const tablesContainer = document.getElementById('tables-container');
            
            svgContainer.innerHTML = '';
            tablesContainer.innerHTML = '';
            
            tableRects = {};
            wrappers = {};
        }

        // åˆ›å»ºè¡¨æ ¼èŠ‚ç‚¹
        function createTableNodes() {
            const tablesContainer = document.getElementById('tables-container');
            
            Object.keys(tables).forEach((tableName, index) => {
                const fields = tables[tableName];
                const tableInfo = erData.tables.find(t => t.name === tableName);
                const tableType = tableInfo ? tableInfo.type : 'normal';
                
                // åˆ›å»ºè¡¨æ ¼åŒ…è£…å™¨
                const wrapper = document.createElement('div');
                wrapper.className = 'er-wrapper';
                wrapper.id = `wrap-${tableName}`;
                
                // è®¾ç½®è¡¨æ ¼ç±»å‹æ ·å¼
                if (tableType === 'fact') {
                    wrapper.classList.add('fact-table');
                } else if (tableType === 'dim') {
                    wrapper.classList.add('dim-table');
                }
                
                // åˆ›å»ºè¡¨æ ¼
                const table = document.createElement('table');
                table.className = 'er-table';
                
                // åˆ›å»ºè¡¨å¤´
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                const headerCell = headerRow.insertCell();
                headerCell.colSpan = 4;
                headerCell.textContent = tableName;
                headerCell.style.fontWeight = 'bold';
                headerCell.style.textAlign = 'center';
                headerCell.style.background = tableType === 'fact' ? '#e74c3c' : 
                                            tableType === 'dim' ? '#3498db' : '#95a5a6';
                headerCell.style.color = 'white';
                
                // åˆ›å»ºè¡¨ä½“
                const tbody = table.createTBody();
                fields.forEach(field => {
                    const row = tbody.insertRow();
                    
                    // ç±»å‹åˆ—
                    const typeCell = row.insertCell();
                    const isPrimary = field.pk || field.primary;
                    const isForeign = field.fk || field.foreign;
                    
                    if (isPrimary && isForeign) {
                        typeCell.textContent = 'PK/FK';
                        typeCell.className = 'pk-fk';
                    } else if (isPrimary) {
                        typeCell.textContent = 'PK';
                        typeCell.className = 'pk';
                    } else if (isForeign) {
                        typeCell.textContent = 'FK';
                        typeCell.className = 'fk';
                    } else {
                        typeCell.textContent = '';
                    }
                    
                    // å­—æ®µååˆ—
                    const nameCell = row.insertCell();
                    nameCell.textContent = field.key || field.name;
                    
                    // å­—æ®µç±»å‹åˆ—
                    const typeFieldCell = row.insertCell();
                    typeFieldCell.textContent = field.type;
                    
                    // æ³¨é‡Šåˆ—
                    const commentCell = row.insertCell();
                    commentCell.textContent = field.cn || field.comment || '';
                });
                
                wrapper.appendChild(table);
                
                // æ·»åŠ è¡¨æ ¼ç±»å‹æ ‡è¯†
                if (tableType !== 'normal') {
                    const badge = document.createElement('div');
                    badge.className = 'table-type-badge';
                    if (tableType === 'dim') {
                        badge.classList.add('dim-badge');
                    }
                    badge.textContent = tableType === 'fact' ? 'äº‹å®è¡¨' : 'ç»´åº¦è¡¨';
                    wrapper.appendChild(badge);
                }
                
                // è®¾ç½®ä½ç½®
                const x = 100 + (index % 3) * 350;
                const y = 100 + Math.floor(index / 3) * 300;
                wrapper.style.left = x + 'px';
                wrapper.style.top = y + 'px';
                
                tablesContainer.appendChild(wrapper);
                wrappers[tableName] = wrapper;
            });
            
            // æ›´æ–°è¡¨æ ¼çŸ©å½¢ä¿¡æ¯
            updateTableRects();
        }

        // æ›´æ–°è¡¨æ ¼çŸ©å½¢ä¿¡æ¯
        function updateTableRects() {
            const tablesContainer = document.getElementById('tables-container');
            const container = tablesContainer.getBoundingClientRect();
            
            Object.keys(wrappers).forEach(tableName => {
                const wrapper = wrappers[tableName];
                const rect = wrapper.getBoundingClientRect();
                
                tableRects[tableName] = {
                    x: rect.left - container.left,
                    y: rect.top - container.top,
                    width: rect.width,
                    height: rect.height
                };
            });
        }

        // åˆ›å»ºå…³ç³»è¿çº¿
        function createRelationLines() {
            const svgContainer = document.getElementById('svg-container');
            
            // æ¸…ç©ºSVG
            svgContainer.innerHTML = '';
            
            // è®¾ç½®SVGå±æ€§
            svgContainer.setAttribute('width', '5000');
            svgContainer.setAttribute('height', '4000');
            svgContainer.setAttribute('viewBox', '0 0 5000 4000');
            
            // åˆ›å»ºç®­å¤´æ ‡è®°
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto');
            
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#333');
            
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svgContainer.appendChild(defs);
            
            // åˆ›å»ºå…³ç³»çº¿
            relations.forEach((relation, index) => {
                const sourceRect = tableRects[relation.source];
                const targetRect = tableRects[relation.target];
                
                if (!sourceRect || !targetRect) {
                    console.warn(`è·³è¿‡å…³ç³» ${relation.source} -> ${relation.target}ï¼Œç¼ºå°‘è¡¨æ ¼çŸ©å½¢`);
                    return;
                }
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                
                // è®¡ç®—è¿çº¿èµ·ç‚¹å’Œç»ˆç‚¹
                const startX = sourceRect.x + sourceRect.width;
                const startY = sourceRect.y + sourceRect.height / 2;
                const endX = targetRect.x;
                const endY = targetRect.y + targetRect.height / 2;
                
                line.setAttribute('x1', startX);
                line.setAttribute('y1', startY);
                line.setAttribute('x2', endX);
                line.setAttribute('y2', endY);
                line.setAttribute('stroke', relation.isFactDim ? '#52c41a' : '#1890ff');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                
                svgContainer.appendChild(line);
            });
        }

        // æ›´æ–°å·¥å…·æ ä¿¡æ¯
        function updateToolbar() {
            document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
            document.getElementById('lineType').textContent = lineType === 'curve' ? 'æ›²çº¿' : 'ç›´çº¿';
        }

        // æ›´æ–°æ•°æ®ä¿¡æ¯
        function updateDataInfo() {
            if (!erData) return;
            
            document.getElementById('dataTitle').textContent = erData.title || '-';
            document.getElementById('dataTableCount').textContent = erData.tables ? erData.tables.length : 0;
            document.getElementById('dataRelationCount').textContent = erData.relations ? erData.relations.length : 0;
            document.getElementById('dataLastUpdate').textContent = new Date().toLocaleString();
            
            document.getElementById('dataInfo').style.display = 'block';
        }


        function refreshERData() {
            loadERData();
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadButton = document.getElementById('loadButton');
            const refreshButton = document.getElementById('refreshButton');
            
            loadingOverlay.style.display = show ? 'flex' : 'none';
            loadButton.disabled = show;
            refreshButton.disabled = show;
        }

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState(show) {
            const emptyState = document.getElementById('emptyState');
            const canvasContent = document.querySelector('.canvas-content');
            
            emptyState.style.display = show ? 'flex' : 'none';
            canvasContent.style.display = show ? 'none' : 'block';
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
