<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¿æ¡è°ƒè¯•é¡µé¢</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #svg-container { border: 1px solid #ccc; width: 100%; height: 600px; }
        .debug-info { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>ERå…³ç³»çº¿æ¡è°ƒè¯•</h1>
    
    <div class="debug-info">
        <button onclick="loadData()">åŠ è½½æ•°æ®</button>
        <button onclick="createTables()">åˆ›å»ºè¡¨æ ¼</button>
        <button onclick="createLines()">åˆ›å»ºçº¿æ¡</button>
        <button onclick="debugInfo()">è°ƒè¯•ä¿¡æ¯</button>
    </div>
    
    <div id="svg-container"></div>
    
    <div id="debug-output"></div>

    <script>
        let erData = null;
        let tableRects = {};
        
        async function loadData() {
            try {
                const response = await fetch('/api/data?file=merged_er_data.json');
                erData = await response.json();
                console.log('æ•°æ®åŠ è½½æˆåŠŸ:', erData);
                document.getElementById('debug-output').innerHTML += '<p>âœ… æ•°æ®åŠ è½½æˆåŠŸï¼Œè¡¨æ•°é‡: ' + erData.tables.length + ', å…³ç³»æ•°é‡: ' + erData.relations.length + '</p>';
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('debug-output').innerHTML += '<p>âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }
        
        function createTables() {
            if (!erData) {
                alert('è¯·å…ˆåŠ è½½æ•°æ®');
                return;
            }
            
            const svg = document.getElementById('svg-container');
            svg.innerHTML = '';
            svg.setAttribute('viewBox', '0 0 1000 600');
            
            // åˆ›å»ºè¡¨æ ¼
            erData.tables.forEach((table, index) => {
                const x = 50 + (index % 3) * 300;
                const y = 50 + Math.floor(index / 3) * 200;
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', 200);
                rect.setAttribute('height', 100);
                rect.setAttribute('fill', '#e0e0e0');
                rect.setAttribute('stroke', '#333');
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x + 10);
                text.setAttribute('y', y + 20);
                text.setAttribute('font-size', '12');
                text.textContent = table.name;
                
                svg.appendChild(rect);
                svg.appendChild(text);
                
                // è®°å½•è¡¨æ ¼ä½ç½®
                tableRects[table.name] = { x, y, width: 200, height: 100 };
            });
            
            console.log('è¡¨æ ¼ä½ç½®:', tableRects);
            document.getElementById('debug-output').innerHTML += '<p>âœ… è¡¨æ ¼åˆ›å»ºå®Œæˆï¼Œä½ç½®: ' + JSON.stringify(tableRects) + '</p>';
        }
        
        function createLines() {
            if (!erData || Object.keys(tableRects).length === 0) {
                alert('è¯·å…ˆåŠ è½½æ•°æ®å¹¶åˆ›å»ºè¡¨æ ¼');
                return;
            }
            
            const svg = document.getElementById('svg-container');
            
            // åˆ›å»ºç®­å¤´æ ‡è®°
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrow');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '10');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3');
            marker.setAttribute('orient', 'auto');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M0,0 L0,6 L9,3 z');
            path.setAttribute('fill', '#333');
            
            marker.appendChild(path);
            defs.appendChild(marker);
            svg.appendChild(defs);
            
            // åˆ›å»ºå…³ç³»çº¿
            erData.relations.forEach((rel, index) => {
                console.log('å¤„ç†å…³ç³»:', rel);
                
                const sourceRect = tableRects[rel.source];
                const targetRect = tableRects[rel.target];
                
                if (!sourceRect || !targetRect) {
                    console.warn('ç¼ºå°‘è¡¨æ ¼ä½ç½®:', rel.source, rel.target);
                    document.getElementById('debug-output').innerHTML += '<p>âš ï¸ ç¼ºå°‘è¡¨æ ¼ä½ç½®: ' + rel.source + ' -> ' + rel.target + '</p>';
                    return;
                }
                
                // è®¡ç®—è¿æ¥ç‚¹
                const x1 = sourceRect.x + sourceRect.width;
                const y1 = sourceRect.y + sourceRect.height / 2;
                const x2 = targetRect.x;
                const y2 = targetRect.y + targetRect.height / 2;
                
                // åˆ›å»ºçº¿æ¡
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.setAttribute('d', `M${x1},${y1} L${x2},${y2}`);
                line.setAttribute('stroke', '#333');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('marker-end', 'url(#arrow)');
                line.setAttribute('id', `line-${index}`);
                
                svg.appendChild(line);
                
                console.log(`çº¿æ¡ ${index}: M${x1},${y1} L${x2},${y2}`);
                document.getElementById('debug-output').innerHTML += '<p>âœ… çº¿æ¡ ' + index + ': ' + rel.source + ' -> ' + rel.target + ' (' + rel.sourceField + ' -> ' + rel.targetField + ')</p>';
            });
        }
        
        function debugInfo() {
            const lines = document.querySelectorAll('path[id^="line-"]');
            document.getElementById('debug-output').innerHTML += '<p>ğŸ” è°ƒè¯•ä¿¡æ¯:</p>';
            document.getElementById('debug-output').innerHTML += '<p>- è¡¨æ ¼æ•°é‡: ' + Object.keys(tableRects).length + '</p>';
            document.getElementById('debug-output').innerHTML += '<p>- çº¿æ¡æ•°é‡: ' + lines.length + '</p>';
            document.getElementById('debug-output').innerHTML += '<p>- å…³ç³»æ•°é‡: ' + (erData ? erData.relations.length : 0) + '</p>';
        }
    </script>
</body>
</html>
