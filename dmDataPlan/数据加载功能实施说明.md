# 数据加载功能实施说明

## 功能概述

将O线ER关系说明页面的导出数据和导入数据功能合并为一个"数据加载"按钮，通过Python脚本合并`selected_tables.json`和`o_line_relations.json`文件，生成完整的ER关系数据。

## 实施内容

### 1. Python合并脚本

**文件**: `python/merge_er_data.py`

**功能**:
- 读取`selected_tables.json`获取已选表列表
- 读取`o_line_relations.json`获取关系数据
- 读取`table_metadata.json`获取完整表信息
- 合并生成完整的ER关系数据
- 输出到`merged_er_data.json`

**特点**:
- 支持多种数据格式
- 完整的错误处理
- 详细的日志输出
- 字段信息完整性保证

### 2. Web API端点

**端点**: `GET /api/merge-er-data`

**功能**:
- 调用Python合并脚本
- 返回合并后的数据
- 提供详细的执行日志

**响应格式**:
```json
{
  "success": true,
  "message": "数据合并成功",
  "data": { /* 合并后的ER数据 */ },
  "output": "脚本执行输出"
}
```

### 3. 前端页面更新

**文件**: `html/o_erGenHtml_new.html`

**更新内容**:
- 将"加载ER数据"按钮改为"数据加载"
- 添加`loadMergedERData()`函数
- 添加`processMergedData()`函数
- 更新刷新功能调用合并数据加载

## 数据合并逻辑

### 1. 数据源
- **已选表**: `selected_tables.json` → 获取需要显示的表列表
- **关系数据**: `o_line_relations.json` → 获取表之间的关系
- **表元数据**: `table_metadata.json` → 获取表的完整字段信息

### 2. 合并过程
1. 从`selected_tables.json`提取已选表名列表
2. 根据表名从`table_metadata.json`获取完整表信息
3. 从`o_line_relations.json`获取关系数据
4. 合并生成完整的ER关系数据结构

### 3. 输出格式
```json
{
  "title": "O线ER关系图",
  "description": "本图展示了系统数据库的实体关系模型，包括事实表和维度表及其关联关系。",
  "tables": [
    {
      "name": "表名",
      "database": "数据库名",
      "type": "表类型",
      "description": "表描述",
      "fields": [ /* 字段信息 */ ]
    }
  ],
  "relations": [ /* 关系数据 */ ],
  "textBoxes": [],
  "collapseStates": { /* 折叠状态 */ },
  "metadata": {
    "mergeTime": "合并时间",
    "selectedTablesCount": 6,
    "relationsCount": 5,
    "sourceFiles": { /* 源文件信息 */ }
  }
}
```

## 功能特点

### 1. 数据完整性
- ✅ 包含所有已选表的完整字段信息
- ✅ 保留所有关系数据
- ✅ 支持多种数据格式
- ✅ 自动处理缺失数据

### 2. 错误处理
- ✅ 文件不存在时的优雅处理
- ✅ 数据格式错误的容错机制
- ✅ 详细的错误日志
- ✅ 前端错误提示

### 3. 性能优化
- ✅ 后端Python脚本执行
- ✅ 一次性数据合并
- ✅ 减少前端请求次数
- ✅ 缓存合并结果

## 使用方法

### 1. 启动服务器
```bash
cd dmDataPlan/python
python start_server.py
```

### 2. 访问页面
打开浏览器访问: `http://localhost:8080/html/o_erGenHtml_new.html`

### 3. 数据加载
1. 点击"数据加载"按钮
2. 系统自动合并`selected_tables.json`和`o_line_relations.json`
3. 显示合并后的完整ER关系图

## 测试结果

### 1. Python脚本测试
```
✅ 数据合并成功!
合并结果:
  - 表数量: 6
  - 关系数量: 5
  - 合并时间: 2025-09-04T16:00:56.516491
```

### 2. 数据验证
- ✅ 成功读取6个已选表
- ✅ 成功读取5个关系
- ✅ 所有表信息完整
- ✅ 字段信息完整

### 3. 文件生成
- ✅ 生成`merged_er_data.json`文件
- ✅ 数据格式正确
- ✅ 包含完整的元数据信息

## 优势

### 1. 简化操作
- 一个按钮完成数据加载
- 自动合并多个数据源
- 减少用户操作步骤

### 2. 数据一致性
- 确保显示的表与已选表一致
- 关系数据与表数据同步
- 避免数据不匹配问题

### 3. 维护性
- Python脚本易于维护
- 清晰的合并逻辑
- 详细的日志记录

## 注意事项

### 1. 依赖文件
- 确保`selected_tables.json`存在
- 确保`o_line_relations.json`存在
- 确保`table_metadata.json`存在

### 2. 权限要求
- Python脚本需要文件读写权限
- Web服务器需要执行脚本权限

### 3. 错误处理
- 如果合并失败，会自动回退到原始数据加载
- 前端会显示详细的错误信息

## 总结

✅ **功能实现**: 成功合并导出和导入功能为数据加载
✅ **数据完整**: 保证字段信息的完整性
✅ **错误处理**: 完善的错误处理机制
✅ **用户体验**: 简化操作流程
✅ **维护性**: 清晰的代码结构和文档

现在用户只需要点击"数据加载"按钮，系统就会自动合并`selected_tables.json`和`o_line_relations.json`文件，生成完整的ER关系数据并显示。
