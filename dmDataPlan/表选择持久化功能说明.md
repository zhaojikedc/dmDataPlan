# 表选择持久化功能说明

## 功能概述

为了解决刷新页面后已选表信息丢失的问题，实现了表选择的持久化功能，将已选表信息保存到JSON文件中，确保数据在页面刷新后能够恢复。

## 实现方案

### 1. 数据存储结构

创建了 `dmDataPlan/config/selected_tables.json` 文件来存储已选表信息：

```json
{
  "title": "已选表信息",
  "description": "用户在模型关系创建页面选择的表信息",
  "tables": [
    {
      "name": "dim.dim_tp_air_full_cargo_di",
      "type": "dim",
      "fields": [
        {
          "key": "flight_date",
          "type": "string",
          "pk": true,
          "fk": false,
          "cn": "航班日期"
        }
        // ... 更多字段
      ]
    }
    // ... 更多表
  ],
  "selectedTableNames": ["dim.dim_tp_air_full_cargo_di", "dm_pass_atp.tm_air_flow_config_wide"],
  "last_updated": "2025-01-02T10:00:00.000Z"
}
```

### 2. 核心功能实现

#### 2.1 保存已选表信息
- **函数**: `saveSelectedTablesToFile()`
- **触发时机**: 
  - 选择表时
  - 移除表时
  - 清空选择时
  - 批量添加表时
  - 手动点击"保存表信息"按钮时
- **功能**: 将已选表的完整信息保存到JSON文件

#### 2.2 加载已选表信息
- **函数**: `loadSelectedTablesFromFile()`
- **触发时机**: 页面初始化时
- **功能**: 从JSON文件加载已选表信息并恢复界面状态

#### 2.3 多级回退机制
1. 首先尝试通过API从服务器加载
2. 如果API失败，尝试直接加载本地文件
3. 如果文件不存在，使用空数组作为默认值

### 3. 用户界面优化

#### 3.1 新增保存按钮
在已选表区域添加了"保存表信息"按钮，用户可以手动保存当前选择：

```html
<div style="display: flex; gap: 8px; margin-top: 8px;">
    <button class="ant-btn ant-btn-danger" onclick="clearSelectedTables()" style="flex: 1;">清空选择</button>
    <button class="ant-btn" onclick="saveSelectedTablesToFile()" style="flex: 1;">保存表信息</button>
</div>
```

#### 3.2 自动保存机制
所有表选择操作都会自动触发保存：
- 单个表选择/移除
- 批量添加表
- 清空所有选择

### 4. 数据格式兼容

#### 4.1 表信息格式
按照需求文档的格式保存表信息，包含：
- `name`: 表名
- `type`: 表类型（dim/fact）
- `fields`: 字段列表，包含字段的详细信息

#### 4.2 字段信息格式
每个字段包含：
- `key`: 字段名
- `type`: 数据类型
- `pk`: 是否主键
- `fk`: 是否外键
- `cn`: 中文名称

### 5. 技术实现细节

#### 5.1 数据同步
- 同时保存到localStorage和JSON文件
- 支持API和文件双重保存机制
- 确保数据一致性和可靠性

#### 5.2 错误处理
- 完善的错误处理和日志记录
- 优雅的降级机制
- 用户友好的错误提示

#### 5.3 性能优化
- 异步操作避免阻塞UI
- 智能的数据加载策略
- 最小化不必要的API调用

## 使用说明

### 1. 基本使用
1. 打开页面后，系统会自动加载之前保存的已选表信息
2. 选择表时，系统会自动保存到JSON文件
3. 刷新页面后，已选表信息会自动恢复

### 2. 手动保存
- 点击"保存表信息"按钮可以手动保存当前选择
- 适合在重要操作前进行数据备份

### 3. 数据导出
- 使用"生成表信息JSON"功能可以导出完整的ER关系图数据
- 导出的数据包含表信息和关系信息，格式符合需求文档要求

## 文件结构

```
dmDataPlan/
├── config/
│   ├── selected_tables.json          # 已选表信息文件
│   ├── o_line_table_info.json        # 表元数据文件
│   └── o_line_relations.json         # 关系数据文件
└── html/
    └── o_line_management.html        # 主页面文件
```

## 注意事项

1. **数据一致性**: 确保表元数据文件 `o_line_table_info.json` 存在且格式正确
2. **权限问题**: 确保有写入 `config` 目录的权限
3. **网络环境**: API服务器不可用时，系统会自动回退到文件操作
4. **数据备份**: 建议定期备份 `selected_tables.json` 文件

## 故障排除

### 1. 已选表信息未保存
- 检查浏览器控制台是否有错误信息
- 确认 `config` 目录权限
- 检查API服务器状态

### 2. 页面刷新后数据丢失
- 检查 `selected_tables.json` 文件是否存在
- 确认文件格式是否正确
- 查看控制台加载日志

### 3. 表信息不完整
- 确认 `o_line_table_info.json` 文件存在
- 检查表元数据是否完整
- 验证表名是否匹配

## 后续优化建议

1. **数据验证**: 添加数据完整性验证
2. **版本控制**: 实现数据版本管理
3. **冲突解决**: 处理多用户同时编辑的冲突
4. **性能优化**: 大数据量时的性能优化
5. **用户界面**: 更直观的数据管理界面
