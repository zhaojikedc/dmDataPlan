# 关系页面数据同步功能说明

## 功能概述

已实现关系页面与ER关系图页面的实时数据同步功能，包括：

1. **自动加载关系数据**: 关系页面启动时自动加载`o_line_er_models.json`数据
2. **实时同步操作**: 对关系的增删改操作会实时同步到ER关系图页面
3. **连线自动更新**: ER关系图页面的关系连线会根据关系数据的变化自动更新

## 实现的功能

### 1. 关系页面自动加载数据

**文件**: `dmDataPlan/html/o_line_management.html`

**功能**:
- 页面加载时自动调用`loadRelationsFromFile()`函数
- 从`../config/o_line_er_models.json`加载关系数据
- 与现有数据合并，避免重复
- 自动保存到localStorage

**关键代码**:
```javascript
// 页面加载时初始化
document.addEventListener('DOMContentLoaded', async function() {
    loadDataFromStorage(); // 先从localStorage加载数据
    await loadTableMetadata(); // 加载表元数据
    await loadRelationsFromFile(); // 自动加载关系数据文件
    await loadERData();
    setupEventListeners();
    
    // 初始同步到ER关系图页面
    setTimeout(() => {
        syncToERDiagramPage();
    }, 1000);
});
```

### 2. 关系操作实时同步

**功能**:
- 删除关系时自动同步到ER关系图页面
- 修改关系时自动同步到ER关系图页面
- 新增关系时自动同步到ER关系图页面

**关键代码**:
```javascript
// 删除关系函数
async function deleteER(id) {
    // 从本地数据中删除
    erRelations = erRelations.filter(r => r.id !== id);
    
    // 重新渲染关系表格
    renderERTable();
    
    // 保存到localStorage
    saveDataToStorage();
    
    // 同步到关系说明页面
    syncToERDiagramPage();
    
    alert('删除成功！');
}

// 保存关系函数
async function saveER() {
    // ... 保存逻辑 ...
    if (ok) {
        closeERModal();
        await loadERData();
        saveDataToStorage(); // 同步保存数据
        syncToERDiagramPage(); // 同步到关系说明页面
        alert('保存成功！');
    }
}
```

### 3. 数据同步机制

**同步函数**: `syncToERDiagramPage()`

**功能**:
- 将关系数据转换为ER关系图页面需要的格式
- 保存到localStorage的`erDiagramData`键
- 包含完整的表信息和关系信息

**关键代码**:
```javascript
function syncToERDiagramPage() {
    try {
        // 将关系数据同步到localStorage，供ER关系图页面使用
        const erData = {
            tables: selectedTables.map(tableName => {
                const table = tableMetadata.tables.find(t => t.name === tableName);
                return table ? {
                    name: table.name,
                    database: table.database,
                    type: table.type,
                    description: table.description,
                    fields: table.fields
                } : null;
            }).filter(Boolean),
            relations: erRelations.map(rel => ({
                id: rel.id,
                sourceTable: rel.sourceTable,
                targetTable: rel.targetTable,
                sourceField: rel.sourceField,
                targetField: rel.targetField,
                relationType: rel.relationType,
                relationDesc: rel.relationDesc || rel.description,
                createdBy: rel.createdBy || 'system',
                createdTime: rel.createdTime || rel.createTime
            })),
            timestamp: new Date().toISOString()
        };
        
        // 保存到localStorage，供ER关系图页面读取
        localStorage.setItem('erDiagramData', JSON.stringify(erData));
        
        console.log('关系数据已同步到ER关系图页面');
    } catch (error) {
        console.error('同步数据到ER关系图页面失败:', error);
    }
}
```

### 4. ER关系图页面实时更新

**文件**: `dmDataPlan/html/o_erGenHtml.html`

**功能**:
- 优先从同步数据加载
- 监听localStorage变化
- 定期检查数据时间戳变化
- 自动刷新ER图显示

**关键代码**:
```javascript
// 监听localStorage变化，实现实时同步
window.addEventListener('storage', function(e) {
  if (e.key === 'erDiagramData') {
    console.log('检测到关系数据变化，正在刷新ER图...');
    loadDataFromStorage();
  }
});

// 定期检查数据变化（作为备用方案）
setInterval(() => {
  const syncData = localStorage.getItem('erDiagramData');
  if (syncData) {
    try {
      const parsed = JSON.parse(syncData);
      const currentTimestamp = parsed.timestamp;
      if (currentTimestamp && currentTimestamp !== lastDataTimestamp) {
        console.log('检测到数据时间戳变化，正在刷新ER图...');
        lastDataTimestamp = currentTimestamp;
        loadDataFromStorage();
      }
    } catch (error) {
      console.error('检查数据变化时出错:', error);
    }
  }
}, 2000); // 每2秒检查一次
```

## 使用方法

### 1. 启动服务器
```bash
cd dmDataPlan
python python/start_server.py
```

### 2. 测试自动加载功能
1. 打开 `http://localhost:8080/html/o_line_management.html`
2. 页面会自动加载`o_line_er_models.json`中的关系数据
3. 查看关系表格是否显示了初始化的关系数据

### 3. 测试实时同步功能
1. 在关系页面进行以下操作：
   - 删除一个关系
   - 修改一个关系
   - 新增一个关系
2. 打开 `http://localhost:8080/html/o_erGenHtml.html`
3. 观察ER关系图是否实时更新了连线

### 4. 测试数据同步
1. 在关系页面点击"初始化示例关系"按钮
2. 切换到ER关系图页面
3. 观察关系连线是否自动更新

## 数据流程

```
关系页面 (o_line_management.html)
    ↓ 自动加载
o_line_er_models.json
    ↓ 用户操作 (增删改)
关系数据更新
    ↓ 同步函数
localStorage (erDiagramData)
    ↓ 监听变化
ER关系图页面 (o_erGenHtml.html)
    ↓ 自动刷新
关系连线更新
```

## 技术特点

1. **自动加载**: 页面启动时自动加载关系数据文件
2. **实时同步**: 操作后立即同步到ER关系图页面
3. **双向监听**: 使用storage事件和时间戳检查双重机制
4. **数据完整性**: 保持表信息和关系信息的完整同步
5. **错误处理**: 完善的错误处理和日志记录

## 注意事项

1. 确保`o_line_er_models.json`文件存在且格式正确
2. 两个页面需要在同一个浏览器中打开才能实现实时同步
3. 如果同步失败，可以手动刷新ER关系图页面
4. 数据同步基于localStorage，清除浏览器数据会丢失同步状态

## 故障排除

1. **关系数据未加载**: 检查`o_line_er_models.json`文件是否存在
2. **同步失败**: 检查浏览器控制台是否有错误信息
3. **ER图未更新**: 手动刷新ER关系图页面或检查localStorage数据
4. **连线显示异常**: 检查关系数据的表名和字段名是否正确
