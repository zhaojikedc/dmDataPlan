# 关系数据展示功能说明

## 功能概述

已实现关系页面自动加载和展示`o_line_er_models.json`中的关系数据，包括：

1. **自动加载展示**: 页面启动时自动加载并展示关系数据
2. **实时渲染**: 关系数据变化时实时更新表格显示
3. **状态提示**: 显示加载状态和操作结果
4. **手动刷新**: 提供手动刷新按钮

## 实现的功能

### 1. 关系数据自动加载和展示

**文件**: `dmDataPlan/html/o_line_management.html`

**功能**:
- 页面加载时自动调用`loadRelationsFromFile()`函数
- 从`../config/o_line_er_models.json`加载关系数据
- 自动渲染到关系表格中
- 显示加载状态和结果

**关键代码**:
```javascript
// 页面加载时初始化
document.addEventListener('DOMContentLoaded', async function() {
    loadDataFromStorage(); // 先从localStorage加载数据
    await loadTableMetadata(); // 加载表元数据
    await loadRelationsFromFile(); // 自动加载关系数据文件
    await loadERData();
    setupEventListeners();
    
    // 确保关系表格被渲染
    setTimeout(() => {
        renderERTable();
        syncToERDiagramPage();
    }, 500);
});
```

### 2. 关系表格渲染函数

**函数**: `renderERTable()`

**功能**:
- 渲染`erRelations`数组中的所有关系数据
- 显示源表、目标表、字段、关系类型等信息
- 提供编辑和删除操作按钮
- 处理空数据状态

**关键代码**:
```javascript
function renderERTable() {
    try {
        const tableBody = document.getElementById('erTableBody');
        if (!tableBody) {
            console.error('找不到关系表格元素');
            return;
        }
        
        tableBody.innerHTML = '';
        
        if (!erRelations || erRelations.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" style="text-align: center; color: #999;">暂无关系数据</td>';
            tableBody.appendChild(row);
            return;
        }
        
        erRelations.forEach(r => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${r.sourceTable || '-'}</td>
                <td>${r.targetTable || '-'}</td>
                <td>${r.sourceField || '-'}</td>
                <td>${r.targetField || '-'}</td>
                <td>${getRelationTypeName(r.relationType) || '-'}</td>
                <td>${r.isFactDim === 'fact' ? '事实关系' : (r.isFactDim === 'dimension' ? '维度关系' : '-')}</td>
                <td>${r.createTime || r.createdTime || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="ant-btn" onclick="editER('${r.id}')">编辑</button>
                        <button class="ant-btn ant-btn-danger" onclick="deleteER('${r.id}')">删除</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        console.log(`渲染了 ${erRelations.length} 条关系数据`);
    } catch (error) {
        console.error('渲染关系表格失败:', error);
    }
}
```

### 3. 数据加载和合并逻辑

**函数**: `loadRelationsFromFile()`

**功能**:
- 从JSON文件加载关系数据
- 智能合并，避免重复数据
- 显示加载状态和结果
- 自动渲染表格

**关键代码**:
```javascript
async function loadRelationsFromFile() {
    try {
        console.log('正在从文件加载关系数据...');
        const response = await fetch('../config/o_line_er_models.json');
        if (!response.ok) {
            console.log('关系数据文件不存在或无法访问，使用默认数据');
            return;
        }
        
        const data = await response.json();
        if (data.erModels && data.erModels.length > 0) {
            // 将文件中的关系数据合并到当前关系数据中
            const existingIds = new Set(erRelations.map(r => r.id));
            const newRelations = data.erModels.filter(r => !existingIds.has(r.id));
            
            if (newRelations.length > 0) {
                erRelations = [...erRelations, ...newRelations];
                console.log(`从文件加载了 ${newRelations.length} 条新关系数据`);
                
                // 保存到localStorage
                saveDataToStorage();
                
                // 重新渲染关系表格
                renderERTable();
                
                // 显示加载成功提示
                showStatusMessage(`✅ 成功从文件加载了 ${newRelations.length} 条关系数据`, 'success');
            } else {
                console.log('没有新的关系数据需要加载');
                // 即使没有新数据，也要渲染现有数据
                renderERTable();
            }
        } else {
            console.log('文件中没有关系数据');
            // 渲染现有数据
            renderERTable();
        }
    } catch (error) {
        console.error('从文件加载关系数据失败:', error);
        showStatusMessage('❌ 从文件加载关系数据失败', 'error');
    }
}
```

### 4. 状态消息显示

**函数**: `showStatusMessage()`

**功能**:
- 显示操作状态和结果
- 支持成功、错误、警告等不同类型
- 自动消失
- 美观的UI设计

**关键代码**:
```javascript
function showStatusMessage(message, type = 'info') {
    // 创建状态消息元素
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message ${type}`;
    statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        font-size: 14px;
        z-index: 9999;
        max-width: 400px;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    `;
    
    // 根据类型设置背景色
    switch (type) {
        case 'success':
            statusDiv.style.backgroundColor = '#52c41a';
            break;
        case 'error':
            statusDiv.style.backgroundColor = '#ff4d4f';
            break;
        case 'warning':
            statusDiv.style.backgroundColor = '#faad14';
            break;
        default:
            statusDiv.style.backgroundColor = '#1890ff';
    }
    
    statusDiv.textContent = message;
    document.body.appendChild(statusDiv);
    
    // 3秒后自动移除
    setTimeout(() => {
        if (statusDiv.parentNode) {
            statusDiv.parentNode.removeChild(statusDiv);
        }
    }, 3000);
}
```

### 5. 手动刷新功能

**函数**: `refreshRelationsFromFile()`

**功能**:
- 提供手动刷新按钮
- 重新加载关系数据文件
- 更新表格显示

**关键代码**:
```javascript
async function refreshRelationsFromFile() {
    try {
        showStatusMessage('正在刷新关系数据...', 'info');
        await loadRelationsFromFile();
    } catch (error) {
        console.error('刷新关系数据失败:', error);
        showStatusMessage('刷新关系数据失败', 'error');
    }
}
```

## 使用方法

### 1. 启动服务器
```bash
cd dmDataPlan
python python/start_server.py
```

### 2. 查看自动加载的关系数据
1. 打开 `http://localhost:8080/html/o_line_management.html`
2. 页面会自动加载`o_line_er_models.json`中的关系数据
3. 在关系表格中查看加载的数据
4. 右上角会显示加载状态提示

### 3. 手动刷新关系数据
1. 点击"刷新关系数据"按钮
2. 系统会重新加载关系数据文件
3. 表格会更新显示最新的数据

### 4. 查看关系数据详情
关系表格显示以下信息：
- **源表**: 关系中的源表名
- **目标表**: 关系中的目标表名
- **源字段**: 源表中的关联字段
- **目标字段**: 目标表中的关联字段
- **关系类型**: 一对一、一对多等
- **关系性质**: 事实关系或维度关系
- **创建时间**: 关系的创建时间
- **操作**: 编辑和删除按钮

## 数据展示特点

### 1. 智能合并
- 避免重复加载相同的关系数据
- 基于关系ID进行去重
- 只加载新的关系数据

### 2. 实时更新
- 数据变化时立即更新表格显示
- 操作后自动刷新表格
- 保持数据同步

### 3. 状态反馈
- 显示加载进度和结果
- 错误信息提示
- 操作成功确认

### 4. 用户友好
- 空数据状态提示
- 清晰的数据展示
- 直观的操作按钮

## 技术特点

1. **自动加载**: 页面启动时自动加载关系数据
2. **智能合并**: 避免重复数据，只加载新数据
3. **实时渲染**: 数据变化时立即更新显示
4. **状态提示**: 完整的操作反馈机制
5. **错误处理**: 完善的异常处理机制

## 注意事项

1. 确保`o_line_er_models.json`文件存在且格式正确
2. 关系数据需要包含必要的字段（id、sourceTable、targetTable等）
3. 如果文件不存在，系统会显示相应提示
4. 数据加载失败时会有错误提示

## 故障排除

1. **关系数据未显示**: 检查`o_line_er_models.json`文件是否存在
2. **表格为空**: 检查文件中是否有`erModels`数组
3. **加载失败**: 检查浏览器控制台是否有错误信息
4. **数据不完整**: 检查关系数据是否包含所有必要字段
