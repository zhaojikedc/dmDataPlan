# 页面初始化错误修复说明

## 问题描述

在优化左侧栏大小后，页面刷新时出现错误：
```
页面初始化失败: loadSelectedTablesFromFile is not defined
```

## 问题原因

在之前的优化过程中，我删除了 `loadSelectedTablesFromFile` 函数，但是在页面初始化时（`DOMContentLoaded` 事件中）仍然在调用这个函数，导致 `ReferenceError`。

## 解决方案

重新添加了 `loadSelectedTablesFromFile` 函数，保持页面初始化逻辑的完整性。

## 修复内容

### 1. 重新添加 `loadSelectedTablesFromFile` 函数

```javascript
// 从JSON文件加载已选表信息
async function loadSelectedTablesFromFile() {
    try {
        console.log('正在加载已选表信息...');
        
        // 首先尝试通过API加载
        try {
            const selectedTablesData = await api.getData('selected_tables.json');
            console.log('selected_tables.json API返回:', selectedTablesData);
            
            // 处理API返回的数据结构
            let tableNames = [];
            if (selectedTablesData && selectedTablesData.selectedTableNames) {
                tableNames = selectedTablesData.selectedTableNames;
            } else if (selectedTablesData && Array.isArray(selectedTablesData)) {
                // 如果返回的是数组，取最后一个元素
                const lastItem = selectedTablesData[selectedTablesData.length - 1];
                if (lastItem && lastItem.selectedTableNames) {
                    tableNames = lastItem.selectedTableNames;
                }
            }
            
            if (tableNames.length > 0) {
                selectedTables = tableNames;
                console.log('从selected_tables.json API加载已选表信息成功:', selectedTables);
                updateSelectedTablesDisplay();
                return;
            }
        } catch (error) {
            console.log('selected_tables.json API加载失败，尝试直接加载文件:', error);
        }
        
        // 如果API失败，尝试直接加载文件
        try {
            const response = await fetch('../config/selected_tables.json');
            if (response.ok) {
                const selectedTablesData = await response.json();
                console.log('selected_tables.json文件内容:', selectedTablesData);
                
                if (selectedTablesData && selectedTablesData.selectedTableNames) {
                    selectedTables = selectedTablesData.selectedTableNames;
                    console.log('从selected_tables.json文件加载已选表信息成功:', selectedTables);
                    updateSelectedTablesDisplay();
                    return;
                }
            }
        } catch (fileError) {
            console.log('selected_tables.json文件加载失败:', fileError);
        }
        
        // 最后尝试从localStorage加载
        try {
            const tablesData = localStorage.getItem(TABLES_KEY);
            if (tablesData) {
                const parsed = JSON.parse(tablesData);
                if (parsed.selectedTables && parsed.selectedTables.length > 0) {
                    selectedTables = parsed.selectedTables;
                    console.log('从localStorage加载已选表信息成功:', selectedTables);
                    updateSelectedTablesDisplay();
                    return;
                }
            }
        } catch (localError) {
            console.log('从localStorage加载失败:', localError);
        }
        
        console.log('未找到已选表信息，使用空数组');
        selectedTables = [];
        updateSelectedTablesDisplay();
        
    } catch (error) {
        console.error('加载已选表信息失败:', error);
        selectedTables = [];
        updateSelectedTablesDisplay();
    }
}
```

### 2. 函数功能说明

该函数负责从多个数据源加载已选表信息：

1. **API加载**: 首先尝试通过 `api.getData('selected_tables.json')` 加载
2. **文件加载**: 如果API失败，尝试直接加载 `../config/selected_tables.json` 文件
3. **本地存储加载**: 如果文件加载失败，尝试从 `localStorage` 加载
4. **默认处理**: 如果所有方法都失败，使用空数组

### 3. 数据源优先级

1. **selected_tables.json API** (最高优先级)
2. **selected_tables.json 文件**
3. **localStorage** (最低优先级)

## 修复效果

- ✅ 页面初始化不再报错
- ✅ 已选表信息能够正常加载
- ✅ 保持了原有的功能完整性
- ✅ 支持多种数据源的回退机制

## 验证方法

1. 打开 `o_line_management.html` 页面
2. 检查浏览器控制台，确认没有 `loadSelectedTablesFromFile is not defined` 错误
3. 验证已选表信息是否正常加载
4. 测试页面刷新功能

## 注意事项

- 该函数是页面初始化的关键组件，不能删除
- 函数支持多种数据源，提供良好的容错性
- 如果将来需要进一步优化，应该考虑重构而不是删除

## 相关文件

- `c:\Users\yangli\Desktop\cursor\dmDataPlan\html\o_line_management.html`
- `c:\Users\yangli\Desktop\cursor\dmDataPlan\config\selected_tables.json`
